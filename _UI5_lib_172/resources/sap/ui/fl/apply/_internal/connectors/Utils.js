/*
 * ! OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/security/encodeURLParameters","sap/base/Log","sap/ui/fl/Layer","sap/ui/fl/LayerUtils"],function(e,L,c,d){"use strict";var A="sap/ui/fl/apply/_internal/connectors/";var S={connector:"StaticFileConnector"};function s(r){function b(C,o){return new Date(C.creation)-new Date(o.creation);}["changes","variantChanges","variants","variantDependentControlChanges","variantManagementChanges"].forEach(function(a){r[a]=r[a].sort(b);});return r;}function _(l,v){return l.filter(function(a){return v.indexOf(a)!==-1||v[0]==="ALL";});}return{getConnectors:function(n,l){var C=sap.ui.getCore().getConfiguration().getFlexibilityServices();var m=[];if(l){m=[S];}m=m.concat(C);return new Promise(function(r){var a=m.map(function(b){var f=b.connector;var g;if(!b.custom){g=n+f;}else{g=l?b.applyConnector:b.writeConnector;}return g;});sap.ui.require(a,function(){Array.from(arguments).forEach(function(o,i){if(!l){if(!m[i].layers){m[i].layers=o.layers;}else{m[i].layers=_(m[i].layers,o.layers);}}m[i].connectorModule=o;});r(m);});});},getApplyConnectors:function(){return this.getConnectors(A,true);},logAndResolveDefault:function(r,C,f,E){L.error("Connector ("+C.connector+") failed call '"+f+"': "+E);return r;},getUrl:function(r,p,P){if(!r||!p.url){throw new Error("Not all necessary parameters were passed");}var u=p.url+r;if(p.cacheKey){u+="~"+p.cacheKey+"~/";}if(p.reference){u+=p.reference;}else if(p.fileName){u+=p.fileName;}if(P){Object.keys(P).forEach(function(k){if(P[k]===undefined){delete P[k];}});var q=e(P);if(q.length>0){u+="?"+q;}}return u;},sendRequest:function(u,m,p){m=m||"GET";m=m.toUpperCase();return new Promise(function(r,a){var x=new XMLHttpRequest();x.open(m,u);if((m==="GET"||m==="HEAD")&&(!p||!p.xsrfToken)){x.setRequestHeader("X-CSRF-Token","fetch");}if((m==="POST"||m==="PUT"||m==="DELETE")&&p&&p.xsrfToken){x.setRequestHeader("X-CSRF-Token",p.xsrfToken);}if(p&&p.contentType){x.setRequestHeader("Content-Type",p.contentType);}if(p&&p.dataType){x.responseType=p.dataType;}if(p&&p.payload){x.send(p.payload);}else{x.send();}x.onload=function(){if(x.status>=200&&x.status<400){var R={};var C=x.getResponseHeader("Content-Type");if(C&&C.startsWith("application/json")){R.response=x.response?JSON.parse(x.response):undefined;}R.status=x.status;R.xsrfToken=x.getResponseHeader("X-CSRF-Token");r(R);}else{a({status:x.status,message:x.statusText});}};});},getEmptyFlexDataResponse:function(){return Object.assign({},{changes:[],variants:[],variantChanges:[],variantDependentControlChanges:[],variantManagementChanges:[]});},getGroupedFlexObjects:function(f){var g={};Object.keys(c).forEach(function(l){g[l]=this.getEmptyFlexDataResponse();g[l].index=d.getLayerIndex(l);}.bind(this));f.forEach(function(F){var l=F.layer;if(F.fileType==="ctrl_variant"&&F.variantManagementReference){g[l].variants.push(F);}else if(F.fileType==="ctrl_variant_change"){g[l].variantChanges.push(F);}else if(F.fileType==="ctrl_variant_management_change"){g[l].variantManagementChanges.push(F);}else if(F.fileType==="change"){if(F.variantReference){g[l].variantDependentControlChanges.push(F);}else{g[l].changes.push(F);}}});Object.keys(g).forEach(function(l){s(g[l]);});return g;},filterAndSortResponses:function(g){var r=[];Object.keys(g).forEach(function(l){r.push(g[l]);});r=r.filter(function(R){return R.changes.length>0||R.variants.length>0||R.variantChanges.length>0||R.variantManagementChanges.length>0||R.variantDependentControlChanges.length>0;});r.sort(function(a,b){return a.index-b.index;});return r;}};});
