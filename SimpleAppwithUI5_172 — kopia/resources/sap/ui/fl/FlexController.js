/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/registry/ChangeRegistry","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/FlexCustomData","sap/ui/fl/Change","sap/ui/fl/Variant","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/context/ContextManager","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/util/reflection/XmlTreeModifier","sap/ui/core/Component","sap/base/Log","sap/base/util/restricted/_uniqWith"],function(C,U,L,F,a,V,b,c,d,A,e,J,X,f,g,_){"use strict";var h=function(s,i){this._oChangePersistence=undefined;this._sComponentName=s||"";this._sAppVersion=i||U.DEFAULT_APP_VERSION;if(this._sComponentName&&this._sAppVersion){this._createChangePersistence();}};h.PENDING="sap.ui.fl:PendingChange";h.prototype.setComponentName=function(s){this._sComponentName=s;this._createChangePersistence();};h.prototype.getComponentName=function(){return this._sComponentName;};h.prototype.getAppVersion=function(){return this._sAppVersion;};h.prototype.getVariantModelData=function(){var D;if(this._oChangePersistence&&this._oChangePersistence._oVariantController._mVariantManagement&&Object.keys(this._oChangePersistence._oVariantController._mVariantManagement).length>0){D=this._oChangePersistence._oVariantController.fillVariantModel();}return D;};h.prototype.setVariantSwitchPromise=function(p){this._oVariantSwitchPromise=p;};h.prototype.waitForVariantSwitch=function(){if(!this._oVariantSwitchPromise){this._oVariantSwitchPromise=Promise.resolve();}return this._oVariantSwitchPromise;};h.prototype.createBaseChange=function(o,i){var j;var k;var l=c._getContextIdsFromUrl();if(l.length>1){throw new Error("More than one DesignTime Context is currently active.");}if(!i){throw new Error("No application component found. To offer flexibility a valid relation to its owning component must be present.");}o.reference=this.getComponentName();o.packageName="$TMP";o.context=l.length===1?l[0]:"";o.validAppVersions=U.getValidAppVersions({appVersion:this.getAppVersion(),developerMode:o.developerMode,scenario:o.scenario});j=a.createInitialFileContent(o);k=new a(j);if(o.variantReference){k.setVariantReference(o.variantReference);}return k;};h.prototype.createChange=function(o,i){var j;var k;return Promise.resolve().then(function(){if(!i){throw new Error("A flexibility change cannot be created without a targeted control.");}var s=i.id||i.getId();if(!o.selector){o.selector={};}j=i.appComponent||U.getAppComponentForControl(i);if(!j){throw new Error("No application component found. To offer flexibility, the control with the ID '"+s+"' has to have a valid relation to its owning application component.");}Object.assign(o.selector,J.getSelector(s,j));k=this.createBaseChange(o,j);var l=i.controlType||U.getControlType(i);if(!l){throw new Error("No control type found - the change handler can not be retrieved.");}return this._getChangeHandler(k,l,i,J);}.bind(this)).then(function(l){if(l){l.completeChangeContent(k,o,{modifier:J,appComponent:j});}else{throw new Error("Change handler could not be retrieved for change "+JSON.stringify(o)+".");}return k;});};h.prototype.createVariant=function(v,o){var i;var j;if(!o){throw new Error("No Application Component found - to offer flexibility the variant has to have a valid relation to its owning application component.");}if(v.content.variantManagementReference){var k=J.checkControlId(v.content.variantManagementReference,o);if(!k){throw new Error("Generated ID attribute found - to offer flexibility a stable VariantManagement ID is needed to assign the changes to, but for this VariantManagement control the ID was generated by SAPUI5 "+v.content.variantManagementReference);}}v.content.reference=this.getComponentName();v.content.packageName="$TMP";v.content.validAppVersions=U.getValidAppVersions(this.getAppVersion(),v.developerMode,v.scenario);j=V.createInitialFileContent(v);i=new V(j);return i;};h.prototype.addChange=function(o,i){return this.createChange(o,i).then(function(j){var k=U.getAppComponentForControl(i);this.addPreparedChange(j,k);return j;}.bind(this));};h.prototype.addPreparedChange=function(o,i){if(o.getVariantReference()){var m=i.getModel(U.VARIANT_MODEL_NAME);m.addChange(o);}this._oChangePersistence.addChange(o,i);return o;};h.prototype.deleteChange=function(o,i){this._oChangePersistence.deleteChange(o);if(o.getVariantReference()){i.getModel(U.VARIANT_MODEL_NAME).removeChange(o);}};h.prototype.createAndApplyChange=function(o,i){var j;return Promise.resolve().then(function(){return this.addChange(o,i);}.bind(this)).then(function(k){j=k;var p={modifier:J,appComponent:U.getAppComponentForControl(i),view:U.getViewForControl(i)};j.setQueuedForApply();return A.applyChangeOnControl(j,i,p);}).then(function(r){if(!r.success){var E=r.error||new Error("The change could not be applied.");this._oChangePersistence.deleteChange(j,true);throw E;}return j;}.bind(this));};h.prototype._checkDependencies=function(o,D,m,j,r){var R=this._canChangePotentiallyBeApplied(o,j);if(!R){return[];}r.push(o);var s=o.getId();var k=D[s]&&D[s].dependencies||[];for(var i=0,n=k.length;i<n;i++){var l=U.getChangeFromChangesMap(m,k[i]);R=this._checkDependencies(l,D,m,j,r);if(R.length===0){r=[];break;}delete D[s];}return r;};h.prototype._canChangePotentiallyBeApplied=function(o,i){var s=o.getDependentControlSelectorList();s.push(o.getSelector());return!s.some(function(S){return!J.bySelector(S,i);});};h.prototype.waitForChangesToBeApplied=function(s){var S;if(Array.isArray(s)){S=s;}else{S=[s];}var p=S.map(function(v){return this._waitForChangesToBeApplied(v);}.bind(this));return Promise.all(p).then(function(){return undefined;});};h.prototype._waitForChangesToBeApplied=function(s){var o=s.id&&sap.ui.getCore().byId(s.id)||s;var m=this._oChangePersistence.getChangesMapForComponent();var p=[];var D=Object.assign({},m.mDependencies);var i=m.mChanges;var j=i[o.getId()]||[];var n=j.filter(function(l){return!l.isCurrentProcessFinished();},this);var k=s.appComponent||U.getAppComponentForControl(o);var r=[];n.forEach(function(l){var q=this._checkDependencies(l,D,m.mChanges,k,[]);q.forEach(function(t){if(r.indexOf(t)===-1){r.push(t);}});}.bind(this));r.forEach(function(l){p=p.concat(l.addChangeProcessingPromises());},this);p.push(this.waitForVariantSwitch());return Promise.all(p);};h.prototype.saveAll=function(s){return this._oChangePersistence.saveDirtyChanges(s);};h.prototype.processXmlView=function(v,p){var o=f.get(p.componentId);var i=U.getAppComponentForControl(o);var m=i.getManifest();p.siteId=U.getSiteId(i);p.appComponent=i;p.appDescriptor=m;p.modifier=X;p.view=v;return this._oChangePersistence.getChangesForView(p.viewId,p).then(A.applyAllChangesForXMLView.bind(A,p)).catch(this._handlePromiseChainError.bind(this,p.view));};h.prototype._checkForDependentSelectorControls=function(o,p){var D=o.getDependentControlSelectorList();D.forEach(function(s){var i=p.modifier.bySelector(s,p.appComponent,p.view);if(!i){throw new Error("A dependent selector control of the flexibility change is not available.");}});};h.prototype._removeFromAppliedChangesAndMaybeRevert=function(o,i,p,r){var R=Promise.resolve(true);if(r){R=this._revertChange(o,i,p);}return R.then(function(v){this._removeChangeFromControl(v||i,o,p.modifier);return!!v;}.bind(this));};h.prototype._revertChange=function(o,i,p){var m=p.modifier;var s;var j;var I;var k;var l={};return new U.FakePromise().then(function(){if(!i){throw Error("A flexibility change tries to revert changes on a nonexistent control");}j=m.getControlType(i);l=e.getControlIfTemplateAffected(o,i,j,p);}).then(this._getChangeHandler.bind(this,o,l.controlType,l.control,m)).then(function(r){k=r;var M;if(!k){M="Change handler implementation for change not found or change type not enabled for current layer - Change ignored";}else if(!(typeof k.revertChange==="function")){M="No revert change function available to handle revert data for control type "+l.controlType;}if(M){g.error(M);o.markRevertFinished(new Error(M));return new U.FakePromise(false);}if(o.getChangeType()==="stashControl"&&j==="sap.ui.core._StashedControl"){s=true;if(!o.hasRevertData()){k.setChangeRevertData(o,false);}}I=o.isApplyProcessFinished();if(!I&&o.hasApplyProcessStarted()){return o.addPromiseForApplyProcessing().then(function(R){if(R&&R.error){o.markRevertFinished(R.error);throw Error(R.error);}return true;});}return false;}).then(function(P){if(P||(!P&&I)||s){if(!o.hasRevertData()){o.setRevertData(F.getParsedRevertDataFromCustomData(i,o,m));}o.startReverting();return k.revertChange(o,l.control,p);}throw Error("Change was never applied");}).then(function(){l.control=p.modifier.bySelector(o.getSelector(),p.appComponent,p.view);if(l.bTemplateAffected){m.updateAggregation(l.control,o.getContent().boundAggregation);}o.markRevertFinished();return l.control;}).catch(function(E){var n="Change could not be reverted: "+E.message;g.error(n);o.markRevertFinished(n);return false;});};h.prototype._removeChangeFromControl=function(o,i,m){F.destroyAppliedCustomData(o,i,m);};h.prototype._handlePromiseChainError=function(v,E){g.error("Error processing view "+E+".");return v;};h.prototype._getSelectorOfChange=function(o){if(!o||!o.getSelector){return undefined;}return o.getSelector();};h.prototype._getChangeHandler=function(o,s,i,m){var j=o.getChangeType();var l=o.getLayer();return this._getChangeRegistry().getChangeHandler(j,s,i,m,l);};h.prototype._getChangeRegistry=function(){var i=C.getInstance();i.initSettings();return i;};h.prototype.getComponentChanges=function(p,i){return this._oChangePersistence.getChangesForComponent(p,i);};h.prototype.checkForOpenDependenciesForControl=function(s,m,o){return this._oChangePersistence.checkForOpenDependenciesForControl(s,m,o);};h.prototype.hasHigherLayerChanges=function(p){p=p||{};var s=p.upToLayer||L.getCurrentLayer(false);p.includeVariants=true;p.includeCtrlVariants=true;return this.getComponentChanges(p).then(function(v){var H=v===this._oChangePersistence.HIGHER_LAYER_CHANGES_EXIST||v.some(function(o){return L.compareAgainstCurrentLayer(o.getLayer(),s)>0;});return!!H;}.bind(this));};h.prototype._createChangePersistence=function(){this._oChangePersistence=b.getChangePersistenceForComponent(this.getComponentName(),this.getAppVersion());return this._oChangePersistence;};h.prototype.resetChanges=function(l,G,o,s,i){return this._oChangePersistence.resetChanges(l,G,s,i).then(function(j){if(j.length!==0){return this.revertChangesOnControl(j,o);}}.bind(this)).then(function(){if(o){var m=o.getModel(U.VARIANT_MODEL_NAME);if(m){d.update({parameters:[],updateURL:true,updateHashEntry:true,model:m});}}});};h.prototype.discardChanges=function(i,D){var s=L.getCurrentLayer(!!D);var I=0;var l;var o;l=i.length;while(I<i.length){o=i[I];if(o&&o.getLayer&&o.getLayer()===s){this._oChangePersistence.deleteChange(o);}if(l===i.length){I++;}else{l=i.length;}}return this._oChangePersistence.saveDirtyChanges();};h.prototype.discardChangesForId=function(i,D){if(!i){return Promise.resolve();}var o=this._oChangePersistence.getChangesMapForComponent();var j=o.mChanges[i]||[];return this.discardChanges(j,D);};h.prototype.revertChangesOnControl=function(i,o){var p=[];i.forEach(function(j){j.setQueuedForRevert();p.push(function(){var s=this._getSelectorOfChange(j);var k=J.bySelector(s,o);if(!k){g.warning("A flexibility change tries to revert changes on a nonexistent control with id "+s.id);return Promise.resolve();}var P={modifier:J,appComponent:o,view:U.getViewForControl(k)};return this._removeFromAppliedChangesAndMaybeRevert(j,k,P,true).then(function(S){if(S){this._oChangePersistence._deleteChangeInMap(j);}}.bind(this));}.bind(this));}.bind(this));return U.execPromiseQueueSequentially(p);};h.prototype.applyVariantChanges=function(i,o){var p=[];var m=J;var j=i.map(function(k){this._oChangePersistence._addChangeAndUpdateDependencies(o,k);return this._getSelectorOfChange(k);}.bind(this));var s=function(S,t){return S.id===t.id;};j=_(j,s);j.forEach(function(S){p.push(function(){var k=m.bySelector(S,o);if(!k){g.error("A flexibility change tries to change a nonexistent control.");return new U.FakePromise();}return A.applyAllChangesForControl(this._oChangePersistence.getChangesMapForComponent.bind(this._oChangePersistence),o,this,k);}.bind(this));}.bind(this));return U.execPromiseQueueSequentially(p);};h.prototype.removeFromAppliedChangesOnControl=function(o,i,j){var p={modifier:J,appComponent:i,view:U.getViewForControl(j)};return this._removeFromAppliedChangesAndMaybeRevert(o,j,p,false);};h.prototype._updateControlsDependencies=function(m,o){var i;Object.keys(m.mDependencies).forEach(function(s){var D=m.mDependencies[s];if(D.controlsDependencies&&D.controlsDependencies.length>0){var l=D.controlsDependencies.length;while(l--){var S=D.controlsDependencies[l];i=J.bySelector(S,o);if(i){D.controlsDependencies.splice(l,1);delete m.mControlsWithDependencies[i.getId()];}}}});};h.prototype._updateDependencies=function(m,s){if(m.mDependentChangesOnMe[s]){m.mDependentChangesOnMe[s].forEach(function(k){var D=m.mDependencies[k];var i=D?D.dependencies.indexOf(s):-1;if(i>-1){D.dependencies.splice(i,1);}});delete m.mDependentChangesOnMe[s];}};h.prototype._iterateDependentQueue=function(m,o){var i=[];var D=[];var p=[];this._updateControlsDependencies(m,o);Object.keys(m.mDependencies).forEach(function(s){var j=m.mDependencies[s];if(j[h.PENDING]&&j.dependencies.length===0&&!(j.controlsDependencies&&j.controlsDependencies.length>0)){p.push(function(){return j[h.PENDING]().then(function(){D.push(s);i.push(j.changeObject.getId());});});}});return U.execPromiseQueueSequentially(p).then(function(){for(var j=0;j<D.length;j++){delete m.mDependencies[D[j]];}for(var k=0;k<i.length;k++){this._updateDependencies(m,i[k]);}return i;}.bind(this));};h.prototype._processDependentQueue=function(m,o){return this._iterateDependentQueue(m,o).then(function(i){if(i.length>0){return this._processDependentQueue(m,o);}}.bind(this));};h.prototype.saveSequenceOfDirtyChanges=function(D){return this._oChangePersistence.saveSequenceOfDirtyChanges(D);};h.prototype.getResetAndPublishInfo=function(p){p.reference=this._sComponentName;p.appVersion=this._sAppVersion;return this._oChangePersistence.getResetAndPublishInfo(p);};return h;},true);
